# ğŸ—ï¸ Arquitetura Detalhada - EKS KEDA Karpenter

## ğŸ“ Diagrama de Arquitetura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            AWS Cloud (us-east-1)                                 â”‚
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                          Amazon VPC (10.0.0.0/16)                          â”‚ â”‚
â”‚  â”‚                                                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  AZ us-east-1a      â”‚  AZ us-east-1b       â”‚  AZ us-east-1c       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                     â”‚                      â”‚                      â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ Public Subnet   â”‚ â”‚ â”‚ Public Subnet    â”‚ â”‚ â”‚ Public Subnet    â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ 10.0.0.0/19     â”‚ â”‚ â”‚ 10.0.32.0/19     â”‚ â”‚ â”‚ 10.0.64.0/19     â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â”‚                 â”‚ â”‚ â”‚                  â”‚ â”‚ â”‚                  â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â”‚  NAT Gateway 1  â”‚ â”‚ â”‚  NAT Gateway 2   â”‚ â”‚ â”‚  NAT Gateway 3   â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                     â”‚                      â”‚                      â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ Private Subnet  â”‚ â”‚ â”‚ Private Subnet   â”‚ â”‚ â”‚ Private Subnet   â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ 10.0.96.0/19    â”‚ â”‚ â”‚ 10.0.128.0/19    â”‚ â”‚ â”‚ 10.0.160.0/19    â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â”‚                 â”‚ â”‚ â”‚                  â”‚ â”‚ â”‚                  â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â”‚  EKS Nodes      â”‚ â”‚ â”‚  EKS Nodes       â”‚ â”‚ â”‚  EKS Nodes       â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”   â”‚ â”‚ â”‚  â”Œâ”€â”€â”€â”           â”‚ â”‚ â”‚  â”Œâ”€â”€â”€â”           â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â”‚  â”‚Podâ”‚ â”‚Podâ”‚   â”‚ â”‚ â”‚  â”‚Podâ”‚           â”‚ â”‚ â”‚  â”‚Podâ”‚           â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜   â”‚ â”‚ â”‚  â””â”€â”€â”€â”˜           â”‚ â”‚ â”‚  â””â”€â”€â”€â”˜           â”‚ â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚                     Amazon EKS Control Plane                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                   (Gerenciado pela AWS - Multi-AZ)                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   â”‚ API      â”‚  â”‚ etcd     â”‚  â”‚ Controllerâ”‚  â”‚ Schedulerâ”‚          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   â”‚ Server   â”‚  â”‚ Database â”‚  â”‚ Manager   â”‚  â”‚          â”‚          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚                         Kubernetes Namespaces                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ keda (ns)    â”‚  â”‚ karpenter    â”‚  â”‚ monitoring   â”‚              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚              â”‚  â”‚ (ns)         â”‚  â”‚ (ns)         â”‚              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ - Operator   â”‚  â”‚ - Controller â”‚  â”‚ - Prometheus â”‚              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ - Metrics    â”‚  â”‚ - Webhook    â”‚  â”‚ - Grafana    â”‚              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚   Server     â”‚  â”‚              â”‚  â”‚ - Alert Mgr  â”‚              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ keda-test (ns) - Application Namespace               â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                                                      â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  Deployment: sqs-app                        â”‚    â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â€¢ Replica: 1-2000 (auto-scaled)            â”‚    â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â€¢ Image: keda-sqs-reader:latest            â”‚    â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â€¢ Service Account: keda-service-account    â”‚    â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                                                      â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  ScaledObject: sqs-scaledobject             â”‚    â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â€¢ Scaler: aws-sqs-queue                    â”‚    â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â€¢ queueLength: 2                           â”‚    â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â€¢ maxReplicaCount: 2000                    â”‚    â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â€¢ pollingInterval: 10s                     â”‚    â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Amazon SQS FIFO  â”‚  â”‚ Amazon DynamoDB  â”‚  â”‚ Amazon ECR           â”‚          â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚                      â”‚          â”‚
â”‚  â”‚ Queue:           â”‚  â”‚ Table:           â”‚  â”‚ Repository:          â”‚          â”‚
â”‚  â”‚ keda-demo-       â”‚  â”‚ payments         â”‚  â”‚ keda-sqs-reader      â”‚          â”‚
â”‚  â”‚ queue.fifo       â”‚  â”‚                  â”‚  â”‚                      â”‚          â”‚
â”‚  â”‚                  â”‚  â”‚ Capacity:        â”‚  â”‚ Image:               â”‚          â”‚
â”‚  â”‚ Messages: 0-N    â”‚  â”‚ PAY_PER_REQUEST  â”‚  â”‚ keda-sqs-reader:     â”‚          â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚ latest               â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           IAM Roles & Policies                           â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ keda-demo-role    â”‚  â”‚ KarpenterNode   â”‚  â”‚ KarpenterControllerâ”‚    â”‚   â”‚
â”‚  â”‚  â”‚                   â”‚  â”‚ InstanceRole    â”‚  â”‚ Role               â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ Policies:         â”‚  â”‚                 â”‚  â”‚                    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ - SQS Read/Delete â”‚  â”‚ Policies:       â”‚  â”‚ Policies:          â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ - DynamoDB Write  â”‚  â”‚ - EC2 Full      â”‚  â”‚ - EC2 Describe     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ - CloudWatch Read â”‚  â”‚ - EKS Worker    â”‚  â”‚ - IAM PassRole     â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Fluxo de Processamento Detalhado

### ğŸ“Š CenÃ¡rio 1: SQS Scaling

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUXO DE PROCESSAMENTO SQS                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ENVIO DE MENSAGENS
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Script Local â”‚ â”€â”€[boto3]â”€â”€> â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ (mock-sqs    â”‚              â”‚ Amazon SQS FIFO â”‚
   â”‚  -post.py)   â”‚              â”‚ 10.000 msgs     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
2. MONITORAMENTO KEDA                    â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
   â”‚ KEDA Operator    â”‚ â”€[Poll a cada]â”€â”€>â”‚
   â”‚ (namespace keda) â”‚   10 segundos    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
            â”‚                             â”‚
            â”‚ LÃª mÃ©tricas via CloudWatch  â”‚
            â–¼                             â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   â”‚ FÃ³rmula de Scaling:              â”‚   â”‚
   â”‚                                  â”‚   â”‚
   â”‚ desiredReplicas =                â”‚   â”‚
   â”‚   ceil(queueLength / targetValue)â”‚   â”‚
   â”‚                                  â”‚   â”‚
   â”‚ Exemplo:                         â”‚   â”‚
   â”‚ 10.000 msgs / 2 = 5.000 pods     â”‚   â”‚
   â”‚ (limitado a maxReplicas: 2000)   â”‚   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
            â”‚                             â”‚
3. ESCALA DE PODS                         â”‚
            â”‚                             â”‚
            â–¼                             â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
   â”‚ HPA atualiza     â”‚                   â”‚
   â”‚ Deployment:      â”‚                   â”‚
   â”‚ sqs-app          â”‚                   â”‚
   â”‚                  â”‚                   â”‚
   â”‚ Replicas:        â”‚                   â”‚
   â”‚ 1 â†’ 50 pods      â”‚                   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
            â”‚                             â”‚
4. PROVISIONAMENTO DE NODES               â”‚
            â”‚                             â”‚
            â–¼                             â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
   â”‚ Kubernetes Scheduler        â”‚        â”‚
   â”‚ detecta: Pods em "Pending"  â”‚        â”‚
   â”‚ (recursos insuficientes)    â”‚        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
            â”‚                             â”‚
            â–¼                             â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
   â”‚ Karpenter        â”‚                   â”‚
   â”‚ Controller       â”‚                   â”‚
   â”‚                  â”‚                   â”‚
   â”‚ AÃ§Ãµes:           â”‚                   â”‚
   â”‚ 1. Calcula       â”‚                   â”‚
   â”‚    recursos      â”‚                   â”‚
   â”‚    necessÃ¡rios   â”‚                   â”‚
   â”‚ 2. Seleciona     â”‚                   â”‚
   â”‚    tipo de       â”‚                   â”‚
   â”‚    instÃ¢ncia     â”‚                   â”‚
   â”‚ 3. Provisiona    â”‚                   â”‚
   â”‚    EC2 nodes     â”‚                   â”‚
   â”‚                  â”‚                   â”‚
   â”‚ Tempo: 60-90s    â”‚                   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
            â”‚                             â”‚
5. PROCESSAMENTO                          â”‚
            â”‚                             â”‚
            â–¼                             â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
   â”‚ Pod sqs-app-xxx  â”‚ â”€[LÃª msg]â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                  â”‚                   â”‚
   â”‚ AÃ§Ãµes:           â”‚                   â”‚
   â”‚ 1. Recebe msg    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ 2. Processa      â”‚
   â”‚ 3. Salva no      â”‚ â”€â”€> â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    DynamoDB      â”‚     â”‚ DynamoDB     â”‚
   â”‚ 4. Delete msg    â”‚     â”‚ Table:       â”‚
   â”‚    da fila       â”‚     â”‚ payments     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
6. SCALE-DOWN
            â”‚
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Fila vazia (queueLength = 0)   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ KEDA Operator    â”‚
   â”‚ Scale-down:      â”‚
   â”‚ 50 â†’ 1 pods      â”‚
   â”‚                  â”‚
   â”‚ Tempo:           â”‚
   â”‚ 2 min (config)   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Karpenter        â”‚
   â”‚ Remove nodes     â”‚
   â”‚ subutilizados    â”‚
   â”‚                  â”‚
   â”‚ ApÃ³s: 10 min     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ›ï¸ CenÃ¡rio 2: HTTP Scaling (Black Friday)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   FLUXO DE SCALING HTTP (KEDA)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. TRÃFEGO HTTP
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Load Test    â”‚ â”€â”€[HTTP POST]â”€â”€> â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Script       â”‚    /api/payment   â”‚ ALB / Ingress      â”‚
   â”‚ (k6, vegeta) â”‚                   â”‚ (LoadBalancer)     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
2. INTERCEPTOR KEDA HTTP                      â”‚
                                              â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ KEDA HTTP Add-on Interceptor      â”‚
                      â”‚                                   â”‚
                      â”‚ FunÃ§Ãµes:                          â”‚
                      â”‚ 1. Intercepta todas as requests   â”‚
                      â”‚ 2. Conta RPS (requests/second)    â”‚
                      â”‚ 3. Roteia para pods disponÃ­veis   â”‚
                      â”‚ 4. ExpÃµe mÃ©tricas para KEDA       â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
3. DECISÃƒO DE SCALING                 â”‚
                                      â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ HTTPScaledObject                  â”‚
                      â”‚                                   â”‚
                      â”‚ Config:                           â”‚
                      â”‚ - targetPendingRequests: 100      â”‚
                      â”‚ - scaleTargetRef: ecommerce-ui    â”‚
                      â”‚                                   â”‚
                      â”‚ LÃ³gica:                           â”‚
                      â”‚ Se RPS > 100:                     â”‚
                      â”‚   desiredPods = ceil(RPS / 100)   â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
4. SCALING                            â”‚
                                      â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ Deployment: ecommerce-ui          â”‚
                      â”‚                                   â”‚
                      â”‚ Replicas: 2 â†’ 40 pods             â”‚
                      â”‚                                   â”‚
                      â”‚ Gatilho:                          â”‚
                      â”‚ - Baixo trÃ¡fego: 2 pods           â”‚
                      â”‚ - Pico Black Friday: 40 pods      â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
5. DISTRIBUIÃ‡ÃƒO DE CARGA              â”‚
                                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚              â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”     ... (40 pods)
   â”‚ Pod 1  â”‚    â”‚ Pod 2  â”‚    â”‚ Pod 3  â”‚
   â”‚        â”‚    â”‚        â”‚    â”‚        â”‚
   â”‚ Serve  â”‚    â”‚ Serve  â”‚    â”‚ Serve  â”‚
   â”‚ 100 RPSâ”‚    â”‚ 100 RPSâ”‚    â”‚ 100 RPSâ”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ Componentes em Detalhes

### 1ï¸âƒ£ Amazon EKS Control Plane

**Componentes gerenciados pela AWS:**

| Componente | FunÃ§Ã£o | Alta Disponibilidade |
|------------|--------|---------------------|
| **API Server** | Endpoint do Kubernetes | 3 instÃ¢ncias (multi-AZ) |
| **etcd** | Armazenamento de estado | 3 instÃ¢ncias (multi-AZ) |
| **Controller Manager** | Gerencia controllers | Ativo/Standby |
| **Scheduler** | Agenda pods em nodes | Ativo/Standby |

**Vantagens:**
- âœ… Gerenciado pela AWS (patches, updates)
- âœ… SLA de 99.95%
- âœ… Backup automÃ¡tico do etcd
- âœ… Sem acesso SSH necessÃ¡rio

### 2ï¸âƒ£ KEDA (Kubernetes Event-Driven Autoscaling)

**Arquitetura interna:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KEDA Architecture                     â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ KEDA Operator  â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚ Kubernetes API       â”‚     â”‚
â”‚  â”‚                â”‚        â”‚ Server               â”‚     â”‚
â”‚  â”‚ â€¢ Watches      â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”‚   ScaledObjectsâ”‚                                      â”‚
â”‚  â”‚ â€¢ Creates HPA  â”‚                                      â”‚
â”‚  â”‚ â€¢ Manages      â”‚                                      â”‚
â”‚  â”‚   triggers     â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚         â”‚                                                â”‚
â”‚         â”‚                                                â”‚
â”‚         â–¼                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Metrics Server â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚ External Scaler      â”‚     â”‚
â”‚  â”‚                â”‚        â”‚ (AWS CloudWatch,     â”‚     â”‚
â”‚  â”‚ â€¢ Fetches      â”‚        â”‚  Prometheus, etc)    â”‚     â”‚
â”‚  â”‚   metrics      â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”‚ â€¢ Exposes to   â”‚                                      â”‚
â”‚  â”‚   HPA          â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚         â”‚                                                â”‚
â”‚         â–¼                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚ HPA (created   â”‚                                      â”‚
â”‚  â”‚  by KEDA)      â”‚                                      â”‚
â”‚  â”‚                â”‚                                      â”‚
â”‚  â”‚ â€¢ Scales       â”‚                                      â”‚
â”‚  â”‚   Deployment   â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Scalers suportados (60+):**
- AWS: SQS, Kinesis, DynamoDB Streams, CloudWatch
- Azure: Service Bus, Event Hubs, Cosmos DB
- GCP: Pub/Sub, Storage
- Outros: Kafka, RabbitMQ, Redis, Prometheus, HTTP

**ConfiguraÃ§Ã£o deste projeto:**

```yaml
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: sqs-scaledobject
  namespace: keda-test
spec:
  scaleTargetRef:
    name: sqs-app                    # Deployment alvo
  minReplicaCount: 1                 # MÃ­nimo de pods
  maxReplicaCount: 2000              # MÃ¡ximo de pods
  pollingInterval: 10                # Verifica a cada 10s
  cooldownPeriod: 120                # Aguarda 2min antes de scale-down
  triggers:
    - type: aws-sqs-queue
      metadata:
        queueURL: https://sqs.us-east-1.amazonaws.com/123456789/keda-demo-queue.fifo
        queueLength: "2"             # 2 mensagens por pod
        awsRegion: "us-east-1"
        identityOwner: operator      # Usa IAM role do KEDA operator
```

### 3ï¸âƒ£ Karpenter (Node Autoscaler)

**DiferenÃ§as vs Cluster Autoscaler:**

| Aspecto | Cluster Autoscaler | Karpenter |
|---------|-------------------|-----------|
| **Tempo de provisionamento** | 3-5 minutos | 60-90 segundos |
| **Flexibilidade de instÃ¢ncias** | Limitado a Node Groups | Qualquer tipo EC2 |
| **ConsolidaÃ§Ã£o** | NÃ£o otimiza | Consolida nodes automaticamente |
| **ConfiguraÃ§Ã£o** | MÃºltiplos Node Groups | 1 NodePool |
| **Custo** | Mais alto | Otimizado |

**NodePool Configuration:**

```yaml
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: default
spec:
  template:
    spec:
      requirements:
        # Tipo de capacidade
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["on-demand"]       # ou "spot"
        
        # Tipos de instÃ¢ncia permitidos
        - key: node.kubernetes.io/instance-type
          operator: In
          values: ["m5.xlarge", "m5.2xlarge"]
        
        # Arquitetura
        - key: kubernetes.io/arch
          operator: In
          values: ["amd64"]
      
      nodeClassRef:
        name: default
  
  # Limites
  limits:
    cpu: 1000                         # MÃ¡ximo de vCPUs no cluster
  
  # DisrupÃ§Ã£o (scale-down)
  disruption:
    consolidationPolicy: WhenUnderutilized
    expireAfter: 720h                 # Remove nodes apÃ³s 30 dias
```

**Fluxo de provisionamento:**

```
1. Pod criado â†’ Estado: Pending
        â–¼
2. Karpenter detecta "Unschedulable" pod
        â–¼
3. Calcula recursos necessÃ¡rios
   â€¢ CPU: 2 cores
   â€¢ MemÃ³ria: 4 GB
   â€¢ Taints/Tolerations
        â–¼
4. Seleciona tipo de instÃ¢ncia
   â€¢ OpÃ§Ãµes: m5.xlarge, m5.2xlarge
   â€¢ Escolhe: m5.xlarge (suficiente + mais barato)
        â–¼
5. LanÃ§a EC2 instance
   â€¢ Usa Launch Template do Karpenter
   â€¢ Aplica User Data para join no cluster
   â€¢ Tempo: ~60 segundos
        â–¼
6. Node entra no cluster
   â€¢ kubectl get nodes â†’ Node "Ready"
        â–¼
7. Scheduler agenda pod no novo node
        â–¼
8. Pod â†’ Estado: Running
```

### 4ï¸âƒ£ Prometheus + Grafana

**Stack de monitoramento:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Monitoring Stack                       â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Prometheus   â”‚â—„â”€â”€â”€â”€â–ºâ”‚ ServiceMonitor       â”‚        â”‚
â”‚  â”‚ Server       â”‚      â”‚ (CRD)                â”‚        â”‚
â”‚  â”‚              â”‚      â”‚                      â”‚        â”‚
â”‚  â”‚ â€¢ Scrape     â”‚      â”‚ â€¢ Define targets     â”‚        â”‚
â”‚  â”‚   targets    â”‚      â”‚ â€¢ Labels             â”‚        â”‚
â”‚  â”‚ â€¢ Store      â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”‚   metrics    â”‚                                       â”‚
â”‚  â”‚ â€¢ Query      â”‚                                       â”‚
â”‚  â”‚   with       â”‚                                       â”‚
â”‚  â”‚   PromQL     â”‚                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚         â”‚                                               â”‚
â”‚         â”‚ PromQL                                        â”‚
â”‚         â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Grafana      â”‚â—„â”€â”€â”€â”€â–ºâ”‚ Dashboards           â”‚        â”‚
â”‚  â”‚              â”‚      â”‚ â€¢ SQS Payments       â”‚        â”‚
â”‚  â”‚ â€¢ Visualize  â”‚      â”‚ â€¢ EKS E-commerce     â”‚        â”‚
â”‚  â”‚ â€¢ Alert      â”‚      â”‚                      â”‚        â”‚
â”‚  â”‚ â€¢ Dashboards â”‚      â”‚ Panels:              â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â€¢ Time series        â”‚        â”‚
â”‚                        â”‚ â€¢ Gauges             â”‚        â”‚
â”‚                        â”‚ â€¢ Stat               â”‚        â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**MÃ©tricas coletadas:**

| Tipo | MÃ©tricas | Fonte |
|------|----------|-------|
| **Cluster** | CPU, Memory, Disk, Network | Node Exporter |
| **Pods** | Container CPU, Memory, Restarts | cAdvisor |
| **KEDA** | Scaled Metrics, HPA status | KEDA Metrics Server |
| **Karpenter** | Nodes provisioned, Pending pods | Karpenter Metrics |
| **AplicaÃ§Ã£o** | Mensagens processadas, LatÃªncia | Custom metrics (Python app) |

### 5ï¸âƒ£ IAM Roles e Policies

**IAM Role para Service Account (IRSA):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          IRSA (IAM Roles for Service Accounts)    â”‚
â”‚                                                   â”‚
â”‚  Pod (keda-test namespace)                        â”‚
â”‚    â”‚                                              â”‚
â”‚    â”‚ Uses ServiceAccount:                         â”‚
â”‚    â”‚ keda-service-account                         â”‚
â”‚    â”‚                                              â”‚
â”‚    â–¼                                              â”‚
â”‚  ServiceAccount                                   â”‚
â”‚    â”‚                                              â”‚
â”‚    â”‚ Annotated with:                              â”‚
â”‚    â”‚ eks.amazonaws.com/role-arn:                  â”‚
â”‚    â”‚ arn:aws:iam::123456:role/keda-demo-role      â”‚
â”‚    â”‚                                              â”‚
â”‚    â–¼                                              â”‚
â”‚  IAM Role: keda-demo-role                         â”‚
â”‚    â”‚                                              â”‚
â”‚    â”œâ”€â”€ Policy: keda-demo-sqs                      â”‚
â”‚    â”‚     â€¢ sqs:ReceiveMessage                     â”‚
â”‚    â”‚     â€¢ sqs:DeleteMessage                      â”‚
â”‚    â”‚     â€¢ sqs:GetQueueAttributes                 â”‚
â”‚    â”‚                                              â”‚
â”‚    â””â”€â”€ Policy: keda-demo-dynamo                   â”‚
â”‚          â€¢ dynamodb:PutItem                       â”‚
â”‚          â€¢ dynamodb:GetItem                       â”‚
â”‚                                                   â”‚
â”‚  Trust Relationship:                              â”‚
â”‚    â†’ OIDC Provider do EKS                         â”‚
â”‚    â†’ Namespace: keda-test                         â”‚
â”‚    â†’ ServiceAccount: keda-service-account         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸŒ Rede e SeguranÃ§a

### VPC Architecture

| Recurso | CIDR | Uso |
|---------|------|-----|
| **VPC** | 10.0.0.0/16 | 65.536 IPs |
| **Public Subnet 1a** | 10.0.0.0/19 | NAT Gateway, ALB |
| **Public Subnet 1b** | 10.0.32.0/19 | NAT Gateway, ALB |
| **Public Subnet 1c** | 10.0.64.0/19 | NAT Gateway, ALB |
| **Private Subnet 1a** | 10.0.96.0/19 | EKS Nodes, Pods |
| **Private Subnet 1b** | 10.0.128.0/19 | EKS Nodes, Pods |
| **Private Subnet 1c** | 10.0.160.0/19 | EKS Nodes, Pods |

### Security Groups

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Security Group: eks-cluster-sg        â”‚
â”‚                                               â”‚
â”‚  Inbound:                                     â”‚
â”‚    â€¢ Port 443 (HTTPS) from 0.0.0.0/0         â”‚
â”‚                                               â”‚
â”‚  Outbound:                                    â”‚
â”‚    â€¢ All traffic                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Security Group: eks-node-sg           â”‚
â”‚                                               â”‚
â”‚  Inbound:                                     â”‚
â”‚    â€¢ Port 1025-65535 from eks-cluster-sg     â”‚
â”‚    â€¢ Port 443 from eks-cluster-sg            â”‚
â”‚    â€¢ All traffic from eks-node-sg (self)     â”‚
â”‚                                               â”‚
â”‚  Outbound:                                    â”‚
â”‚    â€¢ All traffic                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Escalabilidade e Performance

### Limites Configurados

| Componente | MÃ­nimo | MÃ¡ximo | Tempo de Scale |
|------------|--------|--------|----------------|
| **Pods (KEDA)** | 1 | 2000 | 10-30 segundos |
| **Nodes (Karpenter)** | 2 | ~25 | 60-90 segundos |
| **vCPUs (Karpenter)** | 8 | 1000 | N/A |

### Testes de Performance

**Teste SQS - 10.000 mensagens:**
- Pods: 1 â†’ 50
- Nodes: 2 â†’ 9
- Tempo total: ~8 minutos
- Taxa de processamento: ~1.250 msgs/min

**Teste HTTP - Black Friday:**
- Pods: 2 â†’ 40
- Nodes: 2 â†’ 7
- RPS mÃ¡ximo: 4.000 requests/sec
- LatÃªncia P95: < 200ms

---

## ğŸ”’ ConsideraÃ§Ãµes de SeguranÃ§a

### 1. Principle of Least Privilege
- âœ… IAM Roles com permissÃµes mÃ­nimas
- âœ… Service Accounts especÃ­ficos por aplicaÃ§Ã£o
- âœ… Network Policies (opcional, nÃ£o configurado neste lab)

### 2. Secrets Management
- âœ… Credenciais via IAM Roles (nÃ£o hardcoded)
- âœ… AWS Secrets Manager (opcional)
- âœ… Kubernetes Secrets (encrypted at rest no etcd)

### 3. Network Security
- âœ… Nodes em subnets privadas
- âœ… NAT Gateways para acesso Ã  internet
- âœ… Security Groups restritivos
- âœ… VPC Flow Logs (opcional)

### 4. Observability
- âœ… CloudWatch Logs para audit
- âœ… Prometheus mÃ©tricas
- âœ… Grafana dashboards

---

## ğŸ“š ReferÃªncias

- [KEDA Documentation](https://keda.sh/)
- [Karpenter Documentation](https://karpenter.sh/)
- [Amazon EKS Best Practices](https://aws.github.io/aws-eks-best-practices/)
- [Kubernetes Documentation](https://kubernetes.io/docs/)

---

<p align="center">
  <strong>ğŸ“ Arquitetura desenhada para escalabilidade, eficiÃªncia e custo-benefÃ­cio ğŸš€</strong>
</p>
